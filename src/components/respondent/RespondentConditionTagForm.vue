<template>
  <v-dialog
    lazy
    :value="value"
    @input="$emit('input', $event)">
    <v-card>
      <modal-title
        :title="$t('add_condition_tag')"
        @close="$emit('input', false)"></modal-title>
      <v-card-text>
        <v-alert v-if="error">
          {{error}}
        </v-alert>
        <v-layout row>
          <v-select
            autofocus
            autocomplete
            combobox
            v-model="conditionTagName"
            :loading="isLoading"
            :items="conditions"></v-select>
          <v-btn
            @click="save">
            <v-progress-circular v-if="isSaving" indeterminate></v-progress-circular>
            <span v-else>
            {{ $t('save') }}
          </span>
          </v-btn>
        </v-layout>
      </v-card-text>
    </v-card>
  </v-dialog>
</template>

<script>
  import ModalTitle from '../ModalTitle'
  import ConditionTagService from '../../services/condition-tag'
  export default {
    components: {ModalTitle},
    name: 'respondent-condition-form',
    data: () => ({
      conditionTagName: '',
      conditions: [],
      isLoading: false,
      isSaving: false,
      error: null
    }),
    created () {
      this.load()
    },
    props: {
      value: {
        type: Boolean,
        required: true
      },
      respondentId: {
        type: String,
        required: true
      }
    },
    methods: {
      async load () {
        this.isLoading = true
        try {
          this.conditions = await ConditionTagService.getRespondentConditionTagNames()
        } catch (err) {
          this.error = err
        } finally {
          this.isLoading = false
        }
      },
      async save () {
        if (this.conditionTagName.trim() === '') return
        this.isSaving = true
        try {
          const newConditionTag = await ConditionTagService.createConditionTag(this.conditionTagName.trim())
          const respondentConditionTag = await ConditionTagService.createRespondentConditionTag(this.respondentId, newConditionTag.id)
          respondentConditionTag.conditionTag = newConditionTag.copy()
          this.$emit('close', respondentConditionTag)
          this.conditionTagName = ''
        } catch (err) {
          this.error = err
        } finally {
          this.isSaving = false
        }
      },
    }
  }
</script>

<style scoped>

</style>
